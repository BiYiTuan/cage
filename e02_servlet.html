<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Feb 15, 2011 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Cage - Captcha Generator - </title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20110215" />
    <meta http-equiv="Content-Language" content="en" />
                                                    
<meta content="cage, captcha, java, maven" name="keywords"/>
                                                        
<meta content="Cage is a CAPTCHA image generator java library. It is fast, small and simple. Its goal is to generate images that are easy to read for a human but impossible or at least very hard for a computer." name="description"/>
                                                        
<link rel="shortcut icon" href="s/i/icon32.ico"/>
                      
  </head>
  <body class="composite">
    <div id="banner">
                  <a href="index.html" id="bannerLeft">
                Cage - CAptcha GEnerator Java Library
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2011-02-15</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="index.html" title="About">About</a>
            |
                        <a href="quickstart.html" title="QuickStart">QuickStart</a>
            |
                        <a href="templates.html" title="Templates">Templates</a>
            |
                        <a href="examples.html" title="Examples">Examples</a>
            |
                        <a href="tips.html" title="Tips for Captcha Usage">Tips for Captcha Usage</a>
            |
                        <a href="download.html" title="Download">Download</a>
            |
                        <a href="help_and_feedback.html" title="Help & Feedback">Help & Feedback</a>
            |
                        <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
              
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="About">About</a>
            </li>
                  <li class="none">
                          <a href="quickstart.html" title="QuickStart">QuickStart</a>
            </li>
                  <li class="none">
                          <a href="templates.html" title="Templates">Templates</a>
            </li>
                                                                                                            <li class="expanded">
                          <a href="examples.html" title="Examples">Examples</a>
                    <ul>
                      <li class="none">
                          <a href="e01_simple.html" title="Simple">Simple</a>
            </li>
                      <li class="none">
            <strong>Servlet</strong>
          </li>
                      <li class="none">
                          <a href="e03_wicket.html" title="Wicket">Wicket</a>
            </li>
              </ul>
        </li>
                  <li class="none">
                          <a href="tips.html" title="Tips for Captcha Usage">Tips for Captcha Usage</a>
            </li>
                  <li class="none">
                          <a href="download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="help_and_feedback.html" title="Help & Feedback">Help & Feedback</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                              <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                            <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Servlet Example<a name="Servlet_Example"></a></h2><p>The complete source code for this example is available in the <a class="externalLink" href="https://github.com/akiraly/cage/tree/master/cage-examples-parent/cage-e02-servlet">git repo</a>.</p><div class="section"><h3>Overview<a name="Overview"></a></h3><p>This example shows how you can integrate Cage into a web app. This is a standard Java Servlet 2.5 + JSP 2.1 web application. The aim of the app is to show a form with a captcha and an input field. The user has to type in the correct text seen on the picture. The app shows a good or a bad message depending on the user input equaling the token.</p><p>Three relevant files are in this project. A servlet serving Cage captchas and also providing some service methods which are used by a jsp holding the business and view generation logic. The last file is the standard web app descriptor: web.xml.</p></div><div class="section"><h3>CaptchaServlet.java<a name="CaptchaServlet.java"></a></h3><p>Uses a single <a href="./apidocs/com/github/cage/GCage.html">GCage</a> object to generate captcha images that are written directly back to the user response. This is done in the standard doGet() (and a helper) method.</p><p>Few service methods are also present: generateToken() and setToken(). These are used by the jsp to drive the token generation and storing.</p><p>Only one image generation is enabled for a token.</p><div class="source"><pre>public class CaptchaServlet extends HttpServlet {
  private static final long serialVersionUID = 1490947492185481844L;

  private static final Cage cage = new GCage();

  /**
   * Generates a captcha token and stores it in the session.
   * 
   * @param session
   *            where to store the captcha.
   */
  public static void generateToken(HttpSession session) {
    String token = cage.getTokenGenerator().next();

    session.setAttribute(&quot;captchaToken&quot;, token);
    markTokenUsed(session, false);
  }

  /**
   * Used to retrieve previously stored captcha token from session.
   * 
   * @param session
   *            where the token is possibly stored.
   * @return token or null if there was none
   */
  public static String getToken(HttpSession session) {
    Object val = session.getAttribute(&quot;captchaToken&quot;);

    return val != null ? val.toString() : null;
  }

  /**
   * Marks token as used/unused for image generation.
   * 
   * @param session
   *            where the token usage flag is possibly stored.
   * @param used
   *            false if the token is not yet used for image generation
   */
  protected static void markTokenUsed(HttpSession session, boolean used) {
    session.setAttribute(&quot;captchaTokenUsed&quot;, used);
  }

  /**
   * Checks if the token was used/unused for image generation.
   * 
   * @param session
   *            where the token usage flag is possibly stored.
   * @return true if the token was marked as unused in the session
   */
  protected static boolean isTokenUsed(HttpSession session) {
    return !Boolean.FALSE.equals(session.getAttribute(&quot;captchaTokenUsed&quot;));
  }

  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp)
      throws ServletException, IOException {
    HttpSession session = req.getSession(false);
    String token = session != null ? getToken(session) : null;
    if (token == null || isTokenUsed(session)) {
      resp.sendError(HttpServletResponse.SC_NOT_FOUND,
          &quot;Captcha not found.&quot;);

      return;
    }

    setResponseHeaders(resp);
    markTokenUsed(session, true);
    cage.draw(token, resp.getOutputStream());
  }

  /**
   * Helper method, disables HTTP caching.
   * 
   * @param resp
   *            response object to be modified
   */
  protected void setResponseHeaders(HttpServletResponse resp) {
    resp.setContentType(&quot;image/&quot; + cage.getFormat());
    resp.setHeader(&quot;Cache-Control&quot;, &quot;no-cache, no-store&quot;);
    resp.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);
    long time = System.currentTimeMillis();
    resp.setDateHeader(&quot;Last-Modified&quot;, time);
    resp.setDateHeader(&quot;Date&quot;, time);
    resp.setDateHeader(&quot;Expires&quot;, time);
  }
}
</pre></div></div><div class="section"><h3>web.xml<a name="web.xml"></a></h3><p>CaptchaServlet mapping is defined here so requests to ${context-path}/captcha are handled by the servlet. The relevant xml snippet is seen below.</p><div class="source"><pre>&lt;servlet&gt;
  &lt;servlet-name&gt;captcha&lt;/servlet-name&gt;
  &lt;servlet-class&gt;com.github.cage.examples.cage_e02_servlet.CaptchaServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;captcha&lt;/servlet-name&gt;
  &lt;url-pattern&gt;/captcha&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre></div></div><div class="section"><h3>index.jsp<a name="index.jsp"></a></h3><p>This is the entry point for our application. Shows the form, the captcha image and the response messages if there are any. Also contains the business logic (in real world apps you should move the logic out from the view).</p><p>You can see how the service methods of CaptchaServlet (generateToken and getToken) are called. The capthca image element's href is pointed to the CaptchaServlet mapping url.</p><p>Validation is done on POST requests.</p><div class="source"><pre>&lt;%@page import=&quot;com.github.cage.examples.cage_e02_servlet.CaptchaServlet&quot;%&gt;&lt;%@
page contentType=&quot;text/html&quot; pageEncoding=&quot;UTF-8&quot;%&gt;&lt;%
  boolean showGoodResult;
  boolean showBadResult;
  if (&quot;POST&quot;.equals(request.getMethod())) {
    String sessionToken = CaptchaServlet.getToken(session);
    String requestToken = request.getParameter(&quot;captcha&quot;);
    showGoodResult = sessionToken != null &amp;&amp; sessionToken.equals(requestToken);
    showBadResult = !showGoodResult;
  } else {
    showGoodResult = showBadResult = false;
  }

  CaptchaServlet.generateToken(session);
%&gt;&lt;!DOCTYPE html&gt;
&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot; /&gt;
    &lt;title&gt;Captcha Reader&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
&lt;%  if (showGoodResult) {%&gt;
  &lt;h1 style=&quot;color: green;&quot;&gt;Your kung fu is good!&lt;/h1&gt;
&lt;%  } else if (showBadResult) {%&gt;
  &lt;h1 style=&quot;color: red;&quot;&gt;This is not right. Try again!&lt;/h1&gt;
&lt;%  } %&gt;
    &lt;p&gt;Type in the word seen on the picture&lt;/p&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
      &lt;input name=&quot;captcha&quot; type=&quot;text&quot; autocomplete=&quot;off&quot; /&gt;
      &lt;input type=&quot;submit&quot; /&gt;
    &lt;/form&gt;
    &lt;img alt=&quot;captcha image&quot; src=&quot;captcha&quot; /&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre></div></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">Copyright &#169;                   2011.
          All Rights Reserved.      
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
